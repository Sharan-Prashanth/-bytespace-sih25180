================================================================================
FIXED ERRORS LOG - Collaborate Page Issues
================================================================================

--------------------------------------------------------------------------------
ERROR 1: Maximum Update Depth Exceeded
--------------------------------------------------------------------------------

ISSUE:
React error "Maximum update depth exceeded" when loading the collaborate page
for Principal Investigator (PI) accounts. The error did not occur for committee
members who have view-only access.

CAUSE:
The root cause was traced to Radix UI's Tooltip component used in the toolbar.
When Radix Tooltip's `asChild` prop uses the Slot component, it internally uses
`@radix-ui/react-compose-refs` to merge refs. Combined with Plate.js editor's
frequent state updates, this created an infinite re-render loop:

1. User clicks in editor -> Plate.js updates selection state
2. Toolbar re-renders due to selection state change
3. Radix Tooltip's composeRefs triggers ref updates
4. Ref updates trigger React reconciliation
5. Editor state updates again -> Loop back to step 1

ATTEMPTED FIXES:
- Tried memoizing components with React.memo
- Tried stabilizing refs with useCallback and empty dependency arrays
- Tried adding ref forwarding with React.forwardRef

ACTUAL FIX:
Replaced Radix UI Tooltip with native HTML `title` attribute in the toolbar
components. This completely bypasses the composeRefs issue.

FILE CHANGED: client/src/components/ui (plate files)/toolbar.jsx

The withTooltip HOC was modified from:
  - Wrapping components in <Tooltip><TooltipTrigger asChild>...</TooltipTrigger></Tooltip>

To:
  - Simply passing `title={tooltip}` prop to the component

--------------------------------------------------------------------------------
ERROR 2: Editor Not Accepting Input (Cursor Disappears)
--------------------------------------------------------------------------------

ISSUE:
After fixing the maximum depth error, the editor cursor would appear briefly
then disappear. Users could not type in the editor.

CAUSE:
The cursor broadcasting feature for Yjs awareness was listening to the
`selectionchange` DOM event and calling `broadcastCursor()` on every change.
This triggered awareness state updates via `awareness.setLocalState()`, which
caused re-renders that stole focus from the editor.

ACTUAL FIX:
Temporarily disabled:
1. Cursor broadcasting useEffect (selectionchange listener)
2. RemoteCursors component rendering
3. Collaboration mode entirely for debugging

FILE CHANGED: client/src/components/ProposalEditor/editor (our files)/AdvancedProposalEditor.jsx

--------------------------------------------------------------------------------
SUMMARY
--------------------------------------------------------------------------------

The core issue was Radix UI's ref composition conflicting with Plate.js editor
state management. Using native browser APIs (title attribute) instead of Radix
components in high-frequency update scenarios is the recommended approach.

================================================================================

--------------------------------------------------------------------------------
ERROR 3: Online Users Not Synced Between Different User Tabs
--------------------------------------------------------------------------------

ISSUE:
When two users (PI and CMPDI member) open the collaborate page in different tabs,
the PI tab shows 2 users online but the CMPDI tab only shows itself (1 user).
Additionally, cursor positions were not visible when hovering over the editor.

CAUSE:
The collaborate page and the AdvancedProposalEditor were both creating their own
separate useYjsCollaboration hooks. This resulted in:
1. Two separate Yjs provider connections with different client IDs
2. Awareness state not being shared between the page and editor
3. Cursor broadcasting was disabled due to the focus loss fix
4. PI/CI role was not being properly detected (uses proposal context, not user.roles)

ACTUAL FIX:
1. Removed the duplicate useYjsCollaboration hook from collaborate page
2. Added callbacks to AdvancedProposalEditor to notify parent of Yjs state:
   - onCollaborationStateChange: Called when connection/users change
   - onUserJoined: Called when a user joins
   - onUserLeft: Called when a user leaves
3. The editor now maintains a single Yjs connection and reports state to parent
4. Re-enabled cursor broadcasting using mouse events instead of selectionchange
5. Added displayRole parameter to useYjsCollaboration for proper role display
6. Added getDisplayRole function to determine PI/CI/Reviewer based on canEdit/canSuggest

FILES CHANGED:
- client/src/pages/proposal/collaborate/[id].jsx
- client/src/components/ProposalEditor/editor (our files)/AdvancedProposalEditor.jsx
- client/src/hooks/useYjsCollaboration.js

--------------------------------------------------------------------------------
ERROR 4: Users Disconnecting/Reconnecting Rapidly (Only 1 User Shown)
--------------------------------------------------------------------------------

ISSUE:
Both users on the collaborate page (in different tabs) only see 1 user online
(themselves). Server logs show users connecting and disconnecting rapidly:
- User A joins (1 active user)
- User A leaves
- Room cleared from memory
- User B joins (1 active user) - new room created

CAUSE:
1. The useYjsCollaboration hook had `user` object in its dependency array
2. Every time the React component re-renders, the `user` object reference changes
3. This triggers the useEffect cleanup and re-initialization
4. Result: constant connect/disconnect cycle

Additionally:
- Server's onConnect had error: "Cannot read properties of undefined (reading 'name')"
- The context.user was not being safely accessed

ACTUAL FIX:

Server-side (hocuspocusServer.js):
- Added null check for context?.user in onConnect handler
- Added logging for active users count

Client-side (useYjsCollaboration.js):
- Store user in a ref (userRef) instead of using directly
- Extract stable userId (user?._id) for dependency array
- Changed dependency from `user` object to `userId` string
- Use userRef.current inside the effect for actual user data

Client-side (AdvancedProposalEditor.jsx):
- Changed getDisplayRole from useCallback to useMemo
- Pass memoized displayRole instead of calling function each render

FILES CHANGED:
- server/services/hocuspocusServer.js
- client/src/hooks/useYjsCollaboration.js
- client/src/components/ProposalEditor/editor (our files)/AdvancedProposalEditor.jsx

--------------------------------------------------------------------------------
ERROR 5: Cursor Position Off By One Line & Focus Loss When Clicking
--------------------------------------------------------------------------------

ISSUE:
1. Remote cursor appears one line above the actual cursor position on other tabs
2. User cannot place cursor in editor - it blinks and disappears immediately
3. Cannot edit anything in the editor despite cursor appearing briefly

CAUSE:
1. Cursor position issue: The RemoteCursor component used `transform: translateY(-100%)`
   which shifted the cursor up by 100% of its height, causing it to appear one line above
   the actual position.

2. Focus loss issue: The `useCursorBroadcast` hook was calling `awareness.setLocalState()`
   synchronously, which triggered React state updates in RemoteCursors component.
   These synchronous state updates during click events were stealing focus from the editor.

3. Additionally, the `click` event listener was interfering with the browser's native
   cursor placement behavior.

ACTUAL FIX:

1. RemoteCursors.jsx - Fixed cursor positioning:
   - Removed `transform: translateY(-100%)` from the cursor container
   - Reordered elements to put user label above cursor line
   - Adjusted label position from `-top-5` to `-top-6`

2. RemoteCursors.jsx - Fixed useCursorBroadcast hook:
   - Used `requestAnimationFrame` to defer awareness updates to next frame
   - This prevents synchronous state updates from stealing focus
   - Added cleanup for pending animation frames on unmount
   - Increased position change threshold from 2px to 3px
   - Increased throttle interval from 100ms to 150ms

3. AdvancedProposalEditor.jsx - Fixed event listeners:
   - Changed `click` event to `mouseup` to avoid interfering with cursor placement
   - Added `setTimeout(..., 0)` wrapper around broadcastCursor call
   - Used passive event listeners to avoid blocking main thread
   - Increased throttle interval from 150ms to 200ms

FILES CHANGED:
- client/src/components/ProposalEditor/editor (our files)/RemoteCursors.jsx
- client/src/components/ProposalEditor/editor (our files)/AdvancedProposalEditor.jsx

--------------------------------------------------------------------------------
ERROR 6: Maximum Update Depth Error Returned + Server Log Spam
--------------------------------------------------------------------------------

ISSUE:
1. Server logs spamming: "[Hocuspocus] Document proposal-xxx changed by CMPDI Member"
   hundreds of times per second
2. Maximum update depth error returned on collaborate page
3. Even CMPDI member cursor not working

CAUSE:
1. The Hocuspocus server's `onChange` handler was logging every single Yjs update,
   including awareness updates for cursor positions. This caused excessive logging.

2. The cursor broadcasting feature was still causing issues despite previous fixes:
   - `useCursorBroadcast` hook was calling `awareness.setLocalState()` 
   - Even with requestAnimationFrame deferral, awareness updates triggered
     React state updates in `RemoteCursors` component
   - These state updates caused re-renders that triggered more awareness updates
   - Created an infinite loop leading to maximum update depth error

3. The `RemoteCursors` component was listening to awareness 'change' events and
   calling `setRemoteCursors()` on each change, causing excessive re-renders

ACTUAL FIX:
Completely disabled the cursor broadcasting and remote cursors features:

1. Server (hocuspocusServer.js):
   - Removed verbose logging from `onChange` handler
   - Document saves are still logged in `onStoreDocument`

2. Client (AdvancedProposalEditor.jsx):
   - Commented out `useCursorBroadcast` hook import and usage
   - Commented out `RemoteCursors` component rendering
   - Disabled cursor position broadcasting entirely

NOTE: Remote cursor sync is a known complex feature that requires proper implementation
using Yjs cursor plugins (like y-prosemirror cursor plugin) instead of manual
awareness broadcasting. The current manual approach is fundamentally flawed for
React's rendering model.

FILES CHANGED:
- server/services/hocuspocusServer.js
- client/src/components/ProposalEditor/editor (our files)/AdvancedProposalEditor.jsx

================================================================================
