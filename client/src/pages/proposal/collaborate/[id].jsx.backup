'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/router';
import { useAuth } from '../../../context/AuthContext';
import ProtectedRoute from '../../../components/ProtectedRoute';
import LoadingScreen from '../../../components/LoadingScreen';
import AdvancedProposalEditor from '../../../components/ProposalEditor/editor (our files)/AdvancedProposalEditor';
import Chatbot from '../../../components/Chatbot';
import VersionHistory from '../../../components/VersionHistory';
import ChatWindow from '../../../components/ChatWindow';
import { createPortal } from 'react-dom';
import apiClient from '../../../utils/api';
import { 
  getCollaborators, 
  getActiveCollaborators, 
  inviteCollaborator,
  removeCollaborator,
  updateCollaborator 
} from '../../../utils/collaborationApi';

// Custom CSS animations for the collaborate page
const collaborateAnimationStyles = `
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideInUp {
    from { 
      opacity: 0;
      transform: translateY(30px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(300px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slideOutRight {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(300px);
    }
  }
  
  @keyframes fadeInScale {
    from { 
      opacity: 0;
      transform: scale(0.8) translateY(20px);
    }
    to { 
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes slideInScale {
    from { 
      opacity: 0;
      transform: scale(0.7) translateY(20px);
    }
    to { 
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  @keyframes slideOutScale {
    from { 
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    to { 
      opacity: 0;
      transform: scale(0.7) translateY(20px);
    }
  }
  
  .animate-fadeIn {
    animation: fadeIn 0.6s ease-out forwards;
  }
  
  .animate-slideInUp {
    animation: slideInUp 0.6s ease-out forwards;
    animation-fill-mode: both;
  }
  
  .animate-slideInRight {
    animation: slideInRight 0.3s ease-out forwards;
  }
  
  .animate-slideOutRight {
    animation: slideOutRight 0.2s ease-in forwards;
  }
  
  .animate-fadeInScale {
    animation: fadeInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  
  .animate-slideInScale {
    animation: slideInScale 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  
  .animate-slideOutScale {
    animation: slideOutScale 0.2s ease-in forwards;
  }
  
  .animate-fadeOut {
    animation: fadeOut 0.2s ease-in forwards;
  }
  
  .animate-shake {
    animation: shake 0.6s ease-in-out;
  }
  
  .animate-pulse-gentle {
    animation: pulse 2s infinite;
  }
`;



function CollaborateContent() {
    const router = useRouter();
    const { id } = router.query;
    const { user } = useAuth();
    const [proposal, setProposal] = useState(null);
    const [loading, setLoading] = useState(true);
    const [showVersionHistory, setShowVersionHistory] = useState(false);
    const [showSaarthi, setShowSaarthi] = useState(false);
    const [showChatWindow, setShowChatWindow] = useState(false);
    const [wordCount, setWordCount] = useState(0);
    const [characterCount, setCharacterCount] = useState(0);
    const [editorContent, setEditorContent] = useState('');

    // Real collaboration state
    const [collaborators, setCollaborators] = useState([]);
    const [activeCollaborators, setActiveCollaborators] = useState([]);
    const [author, setAuthor] = useState(null);
    const [loadingCollaborators, setLoadingCollaborators] = useState(false);

    // Collaboration modal state
    const [showCollaborateModal, setShowCollaborateModal] = useState(false);
    const [showCollaboratorsList, setShowCollaboratorsList] = useState(false);
    const [collaboratorEmail, setCollaboratorEmail] = useState('');
    const [collaboratorRole, setCollaboratorRole] = useState('');
    const [collaboratorDescription, setCollaboratorDescription] = useState('');
    const [isInviting, setIsInviting] = useState(false);

    // Tooltip state
    const [hoveredCollaborator, setHoveredCollaborator] = useState(null);
    const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

    // Reply window state
    const [replyWindows, setReplyWindows] = useState({});
    const [replyMessages, setReplyMessages] = useState({});

    // Success modal state
    const [showSuccessModal, setShowSuccessModal] = useState(false);

    // Commit Modal States (from edit page)
    const [showCommitModal, setShowCommitModal] = useState(false);
    const [isModalClosing, setIsModalClosing] = useState(false);
    const [isShaking, setIsShaking] = useState(false);
    const [commitMessage, setCommitMessage] = useState('Updated collaboration version with team feedback');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [submissionProgress, setSubmissionProgress] = useState(0);
    const [submissionStage, setSubmissionStage] = useState('');

    // Chat messages state
    const [chatMessages, setChatMessages] = useState([
        {
            type: 'team',
            sender: 'Dr. Raj Patel',
            role: 'Principal Investigator',
            content: 'Welcome everyone! Excited to collaborate on this coal gasification project. Please review the methodology section.',
            time: '2:30 PM'
        },
        {
            type: 'team',
            sender: 'Prof. Michael Chen',
            role: 'Technical Reviewer',
            content: 'The gasification approach looks promising. I suggest we focus on the reactor design specifications in section 3.',
            time: '2:45 PM'
        },
        {
            type: 'ai',
            sender: 'AI Assistant',
            role: 'Collaboration Bot',
            content: 'Based on the current discussion, I recommend reviewing budget allocation for equipment procurement. There might be optimization opportunities.',
            time: '3:00 PM'
        }
    ]);

    // Note: Inline comments are now handled by Plate.js built-in comment feature

    const [suggestions] = useState([
        {
            id: 1,
            type: 'ai',
            category: 'Technical Enhancement',
            title: 'Optimize Gasification Temperature',
            content: 'Consider implementing variable temperature control (800-1200Â°C) based on coal grade. This could improve efficiency by 8-12%.',
            confidence: 87,
            author: 'AI Assistant',
            timestamp: '1 hour ago'
        },
        {
            id: 2,
            type: 'reviewer',
            category: 'Budget Optimization',
            title: 'Partnership Opportunity',
            content: 'BHEL has existing gasification infrastructure. A partnership could reduce equipment costs by 20-25% and accelerate development.',
            author: 'Prof. Michael Chen',
            timestamp: '45 mins ago'
        },
        {
            id: 3,
            type: 'ai',
            category: 'Risk Mitigation',
            title: 'Environmental Compliance',
            content: 'Add contingency plans for meeting stricter emission standards. Consider integrating NOx reduction catalysts.',
            confidence: 92,
            author: 'AI Assistant',
            timestamp: '20 mins ago'
        }
    ]);
    // Sample proposal data
    const sampleProposal = {
        id: id || 1,
        title: "Advanced Coal Gasification Technology for Enhanced Energy Production",
        author: "Dr. Raj Patel",
        status: "under_collaborative_review",
        domain: "Coal Technology & Energy Systems",
        budget: 20000000,
        collaborators: [
            { name: "Dr. Raj Patel", role: "Principal Investigator", status: "online", avatar: "RP" },
            { name: "Prof. Michael Chen", role: "Technical Reviewer", status: "online", avatar: "MC" },
            { name: "Dr. Sarah Kumar", role: "Research Coordinator", status: "away", avatar: "SK" },
            { name: "Dr. Priya Sharma", role: "Environmental Specialist", status: "offline", avatar: "PS" }
        ]
    };

    // Initial proposal content in Plate.js format
    const initialContent = [
        { type: 'h1', children: [{ text: 'Advanced Coal Gasification Technology for Enhanced Energy Production' }] },
        { type: 'p', children: [{ text: '' }] },
        { type: 'h2', children: [{ text: '1. Problem Statement' }] },
        { type: 'p', children: [{ text: 'The coal sector faces significant challenges in optimizing energy extraction while minimizing environmental impact. Traditional coal combustion methods result in only 35-40% energy efficiency, with substantial CO2 emissions and particulate matter release. There is an urgent need for innovative gasification technologies that can improve energy output to 60-65% efficiency while reducing harmful emissions by 40-50%.' }] },
        { type: 'p', children: [{ text: 'Current coal processing facilities in India operate with outdated equipment that struggles to meet environmental compliance standards set by the Ministry of Coal. The lack of advanced gasification infrastructure limits the country\'s ability to maximize coal utilization for power generation and industrial applications.' }] },
        { type: 'h2', children: [{ text: '2. Research Objectives' }] },
        { type: 'p', children: [{ text: 'Primary Objectives:', bold: true }] },
        { type: 'ul', children: [
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Develop an integrated coal gasification system achieving 60%+ energy efficiency' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Design carbon capture mechanisms reducing CO2 emissions by 45%' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Create automated monitoring systems for real-time process optimization' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Establish economic viability models for large-scale implementation' }] }] },
        ]},
        { type: 'h2', children: [{ text: '3. Methodology & Approach' }] },
        { type: 'p', children: [{ text: 'Phase 1: Laboratory Testing (Months 1-8)', bold: true }] },
        { type: 'ul', children: [
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Coal characterization using X-ray fluorescence and thermogravimetric analysis' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Gasification reactor design using computational fluid dynamics modeling' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Catalyst development for enhanced reaction efficiency' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Small-scale prototype testing under controlled conditions' }] }] },
        ]},
        { type: 'p', children: [{ text: 'Phase 2: Pilot Plant Development (Months 9-18)', bold: true }] },
        { type: 'ul', children: [
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Construction of pilot-scale gasification facility' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Integration of carbon capture systems' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Performance testing with various coal grades' }] }] },
            { type: 'li', children: [{ type: 'lic', children: [{ text: 'Environmental impact assessment and monitoring' }] }] },
        ]},
    ];

    // Load collaborators
    const loadCollaborators = async () => {
        if (!id) return;
        
        try {
            setLoadingCollaborators(true);
            const collabData = await getCollaborators(id);
            setCollaborators(collabData.collaborators || []);
            setAuthor(collabData.author);
            console.log('âœ… Collaborators loaded:', collabData);
        } catch (error) {
            console.error('âŒ Failed to load collaborators:', error);
        } finally {
            setLoadingCollaborators(false);
        }
    };

    // Load active collaborators
    const loadActiveCollaborators = async () => {
        if (!id) return;
        
        try {
            const activeData = await getActiveCollaborators(id);
            setActiveCollaborators(activeData.users || []);
        } catch (error) {
            console.error('âŒ Failed to load active collaborators:', error);
        }
    };

    useEffect(() => {
        const loadProposal = async () => {
            try {
                if (id) {
                    console.log('ðŸ“– Loading proposal for collaboration:', id);
                    setLoading(true);
                    
                    try {
                        const response = await apiClient.get(`/api/proposals/${id}`);
                        const proposalData = response.data.proposal || response.data;
                        setProposal(proposalData);
                        console.log('âœ… Proposal loaded for collaboration');
                        
                        // Load collaborators
                        await loadCollaborators();
                        await loadActiveCollaborators();
                    } catch (error) {
                        console.warn('âš ï¸  Using sample data as fallback:', error.message);
                        // Fallback to sample data for demo
                        setProposal(sampleProposal);
                        setEditorContent(initialContent);
                    } finally {
                        setLoading(false);
                    }
                }
            } catch (error) {
                console.error("âŒ Error in loadProposal:", error);
                setProposal(sampleProposal);
                setEditorContent(initialContent);
                setLoading(false);
            }
        };

        loadProposal();

        // Poll for active collaborators every 10 seconds
        const interval = setInterval(() => {
            if (id) {
                loadActiveCollaborators();
            }
        }, 10000);

        return () => clearInterval(interval);
    }, [id]);

    // Handle editor content changes
    const handleEditorContentChange = (content) => {
        setEditorContent(content);
    };

    const handleWordCountChange = (count) => {
        setWordCount(count);
    };

    const handleCharacterCountChange = (count) => {
        setCharacterCount(count);
    };

    // Handle chat message sending
    const handleChatMessageSend = (messageText) => {
        const newMessage = {
            type: 'user',
            sender: user?.name || 'Current User',
            role: user?.role || 'user',
            content: messageText,
            time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        };

        setChatMessages(prev => [...prev, newMessage]);

        // Simulate team responses
        setTimeout(() => {
            const responses = [
                "Great point! Let me review that section.",
                "I agree with your suggestion. We should implement that change.",
                "Interesting observation. What do you think about the budget implications?",
                "That's exactly what I was thinking. Let's discuss this in detail.",
                "Good catch! I'll update the methodology accordingly."
            ];

            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            const teamMembers = ['Prof. Michael Chen', 'Dr. Sarah Kumar', 'Dr. Priya Sharma'];
            const randomMember = teamMembers[Math.floor(Math.random() * teamMembers.length)];

            const responseMessage = {
                type: 'team',
                sender: randomMember,
                role: 'Team Member',
                content: randomResponse,
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            };

            setChatMessages(prev => [...prev, responseMessage]);
        }, 1500);
    };

    // Handle modal close with animation (from edit page)
    const handleCloseModal = () => {
        setIsModalClosing(true);
        setTimeout(() => {
            setShowCommitModal(false);
            setIsModalClosing(false);
        }, 300);
    };

    // Handle commit confirmation (from edit page)
    const handleCommitConfirm = async () => {
        if (!commitMessage.trim()) {
            setIsShaking(true);
            setTimeout(() => setIsShaking(false), 600);
            return;
        }

        try {
            setIsSubmitting(true);
            setSubmissionProgress(0);

            // Simulate submission process
            setSubmissionStage('Validating changes...');
            setSubmissionProgress(20);

            setTimeout(() => {
                setSubmissionStage('Creating new version...');
                setSubmissionProgress(50);
            }, 1000);

            setTimeout(() => {
                setSubmissionStage('Syncing with collaborators...');
                setSubmissionProgress(80);
            }, 2000);

            setTimeout(() => {
                setSubmissionStage('Finalizing...');
                setSubmissionProgress(100);
            }, 3000);

            setTimeout(() => {
                setIsSubmitting(false);
                setSubmissionProgress(0);
                setSubmissionStage('');
                setShowCommitModal(false);
                setCommitMessage('Updated collaboration version with team feedback');

                // Show success modal
                setShowSuccessModal(true);

                // Auto close success modal after 3 seconds
                setTimeout(() => {
                    setShowSuccessModal(false);
                }, 3000);
            }, 4000);

        } catch (error) {
            console.error('Submission error:', error);
            setIsSubmitting(false);
            setSubmissionProgress(0);
            setSubmissionStage('');
            alert('Error creating new version. Please try again.');
        }
    };

    // Handle saving changes
    const handleSaveChanges = () => {
        setShowCommitModal(true);
    };

    // Handle collaboration invitation
    const handleCollaborateInvite = async () => {
        if (!collaboratorEmail || !collaboratorRole) return;

        setIsInviting(true);
        try {
            const result = await inviteCollaborator(id, {
                email: collaboratorEmail,
                role: collaboratorRole,
                description: collaboratorDescription
            });

            if (result.success) {
                alert(`âœ… Collaboration invitation sent to ${collaboratorEmail}!`);
                setCollaboratorEmail('');
                setCollaboratorRole('');
                setCollaboratorDescription('');
                setShowCollaborateModal(false);
                
                // Reload collaborators
                await loadCollaborators();
            }
        } catch (error) {
            console.error('Error sending invitation:', error);
            alert(`âŒ Failed to send invitation: ${error.message}`);
        } finally {
            setIsInviting(false);
        }
    };

    // Handle removing a collaborator
    const handleRemoveCollaborator = async (collaboratorId) => {
        if (!confirm('Are you sure you want to remove this collaborator?')) return;

        try {
            await removeCollaborator(id, collaboratorId);
            alert('âœ… Collaborator removed successfully');
            await loadCollaborators();
        } catch (error) {
            console.error('Error removing collaborator:', error);
            alert(`âŒ Failed to remove collaborator: ${error.message}`);
        }
    };

    // Handle tooltip positioning
    const handleMouseEnter = (collaborator, event) => {
        const rect = event.currentTarget.getBoundingClientRect();
        setTooltipPosition({
            x: rect.left + rect.width / 2,
            y: rect.top - 10
        });
        setHoveredCollaborator(collaborator);
    };

    const handleMouseLeave = () => {
        setHoveredCollaborator(null);
    };

    // Handle reply windows
    const toggleReplyWindow = (commentId) => {
        setReplyWindows(prev => ({
            ...prev,
            [commentId]: !prev[commentId]
        }));
        // Clear any existing message when opening reply window
        if (!replyWindows[commentId]) {
            setReplyMessages(prev => ({
                ...prev,
                [commentId]: ''
            }));
        }
    };

    const handleReplyChange = (commentId, message) => {
        setReplyMessages(prev => ({
            ...prev,
            [commentId]: message
        }));
    };

    const handleReplySubmit = (commentId) => {
        // Handle reply submission logic here
        console.log('Reply submitted for comment', commentId, ':', replyMessages[commentId]);

        // Close reply window and clear message
        setReplyWindows(prev => ({
            ...prev,
            [commentId]: false
        }));
        setReplyMessages(prev => ({
            ...prev,
            [commentId]: ''
        }));
    };

    const handleResolveComment = (commentId) => {
        setInlineComments(prev =>
            prev.map(comment =>
                comment.id === commentId
                    ? {
                        ...comment,
                        resolved: true,
                        resolvedBy: user?.name || 'You',
                        resolvedAt: new Date().toLocaleString()
                    }
                    : comment
            )
        );
        // Close the comment popup after resolving
        setSelectedComment(null);
    };

    if (loading) {
        return <LoadingScreen />;
    };

    if (!proposal) {
        return (
            <div className="min-h-screen bg-white flex items-center justify-center">
                <div className="text-black text-xl">Proposal not found</div>
            </div>
        );
    }

    const onlineCollaborators = proposal.collaborators?.filter(c => c.status === 'online').length || 0;

    return (
        <>
            <style jsx>{collaborateAnimationStyles}</style>
            <div className="min-h-screen bg-white">
                {/* Distinctive Header Section - Matching create.jsx and edit.jsx */}
                <div className="relative bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 min-h-[280px]" style={{ overflow: 'visible' }}>
                    {/* Animated geometric patterns */}
                    <div className="absolute inset-0" style={{ overflow: 'hidden' }}>
                        <div className="absolute top-6 left-10 w-12 h-12 border border-blue-400/30 rounded-full animate-pulse"></div>
                        <div className="absolute top-20 right-20 w-10 h-10 border border-indigo-400/20 rounded-lg rotate-45 animate-spin-slow"></div>
                        <div className="absolute bottom-12 left-32 w-8 h-8 bg-blue-500/10 rounded-full animate-bounce"></div>
                        <div className="absolute top-12 right-40 w-4 h-4 bg-indigo-400/20 rounded-full animate-ping"></div>
                    </div>

                    {/* Overlay gradient */}
                    <div className="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>

                    {/* Header Content */}
                    <div className="relative z-10 max-w-7xl mx-auto px-6 py-10" style={{ overflow: 'visible' }}>
                        <div className="group animate-fadeIn">
                            <div className="flex items-center mb-5">
                                <div className="relative">
                                    <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center shadow-2xl group-hover:shadow-orange-500/25 transition-all duration-500 group-hover:scale-110">
                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                    </div>
                                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-green-400 rounded-full border-2 border-white animate-pulse flex items-center justify-center">
                                        <span className="text-xs text-white font-bold">{onlineCollaborators}</span>
                                    </div>
                                </div>

                                <div className="ml-6">
                                    <div className="flex items-center mb-2">
                                        <h1 className="text-white text-4xl font-black tracking-tight bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent animate-slideInUp">
                                            Collaborative Workspace
                                        </h1>
                                    </div>
                                    <div className="flex items-center space-x-3 animate-slideInUp" style={{ animationDelay: '0.2s' }}>
                                        <div className="flex items-center">
                                            <div className="w-2 h-2 bg-orange-400 rounded-full animate-pulse mr-3"></div>
                                            <span className="text-blue-100 font-semibold text-lg">NaCCER Research Portal</span>
                                        </div>
                                        <div className="h-4 w-px bg-blue-300/50"></div>
                                        <span className="text-blue-200 font-medium text-sm">Team Collaboration</span>
                                    </div>
                                    <div className="flex items-center gap-4 mt-2 text-sm text-blue-200 animate-slideInUp" style={{ animationDelay: '0.4s' }}>
                                        <span>Proposal ID: #{id}</span>
                                        <span>â€¢</span>
                                        <span>Real-time sync active</span>
                                        <span>â€¢</span>
                                        <span className="flex items-center gap-2">
                                            <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                            {onlineCollaborators} online
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* PRISM Banner */}
                            <div className="bg-orange-600 backdrop-blur-md rounded-2xl p-4 border border-orange-300/40 shadow-2xl hover:shadow-orange-500/20 transition-all duration-300 animate-slideInUp" style={{ animationDelay: '0.6s' }}>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-4">
                                        <div className="flex-shrink-0">
                                            <div className="w-10 h-10 bg-gradient-to-br from-white to-orange-50 rounded-lg flex items-center justify-center shadow-lg overflow-hidden border border-orange-200/50">
                                                <img
                                                    src="/images/prism brand logo.png"
                                                    alt="PRISM Logo"
                                                    className="w-10 h-10 object-contain"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <h2 className="text-white font-bold text-xl mb-1 flex items-center">
                                                <span className="text-white drop-shadow-md tracking-wide">PRISM</span>
                                                <div className="ml-3 px-2 py-0.5 bg-gradient-to-r from-green-400/30 to-emerald-400/30 rounded-full flex items-center justify-center border border-green-300/40 backdrop-blur-sm">
                                                    <div className="w-1.5 h-1.5 bg-green-300 rounded-full mr-1.5 animate-pulse"></div>
                                                    <span className="text-white text-xs font-semibold drop-shadow-sm">COLLABORATING</span>
                                                </div>
                                            </h2>
                                            <p className="text-orange-50 text-sm leading-relaxed font-medium opacity-95 drop-shadow-sm">
                                                Proposal Review & Innovation Support Mechanism for Department of Coal's Advanced Research Platform
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Main Content Container */}
                <div className="max-w-7xl mx-auto px-6 py-8 relative">

                    {/* Navigation and Control Buttons */}
                    <div className="flex justify-between items-center mb-6">
                        {/* Back to Dashboard Button */}
                        <button
                            onClick={() => router.push('/dashboard')}
                            className="px-5 py-2.5 rounded-xl bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 text-green-800 border border-green-300 transition-all duration-300 flex items-center gap-3 font-semibold shadow-lg hover:shadow-xl text-sm transform hover:scale-105 animate-fadeIn cursor-pointer"
                        >
                            <div className="w-5 h-5 bg-green-200 rounded-full flex items-center justify-center">
                                <svg className="w-3 h-3 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </div>
                            Back to Dashboard
                        </button>

                        {/* Collaborator Status */}
                        <div className="flex items-center gap-4 animate-fadeIn">
                            {/* View All Collaborators Button */}
                            <button
                                onClick={() => setShowCollaboratorsList(true)}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-all cursor-pointer"
                            >
                                <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span className="text-blue-800 font-semibold text-sm">
                                    {activeCollaborators.length} online â€¢ {(collaborators.length + 1)} total
                                </span>
                            </button>

                            {/* Active Collaborators Display */}
                            <div className="flex -space-x-2">
                                {/* Show author first */}
                                {author && (
                                    <div className="relative">
                                        <div
                                            className="w-10 h-10 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white text-sm font-bold cursor-pointer transition-transform hover:scale-110 bg-blue-600"
                                            onMouseEnter={(e) => handleMouseEnter({
                                                name: author.user?.name || 'Author',
                                                role: 'Principal Investigator',
                                                status: author.isActiveNow ? 'online' : 'offline'
                                            }, e)}
                                            onMouseLeave={handleMouseLeave}
                                        >
                                            {(author.user?.name || 'A').substring(0, 2).toUpperCase()}
                                        </div>
                                        <div className={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border border-white ${author.isActiveNow ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`}></div>
                                    </div>
                                )}
                                
                                {/* Show collaborators */}
                                {collaborators.slice(0, 5).map((collab, index) => {
                                    const getRoleBgColor = (role) => {
                                        switch(role) {
                                            case 'principal_investigator': return 'bg-blue-600';
                                            case 'admin': return 'bg-purple-600';
                                            case 'reviewer': return 'bg-orange-600';
                                            case 'collaborator': return 'bg-green-600';
                                            case 'observer': return 'bg-gray-600';
                                            default: return 'bg-indigo-600';
                                        }
                                    };
                                    
                                    return (
                                        <div key={collab._id || index} className="relative">
                                            <div
                                                className={`w-10 h-10 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white text-sm font-bold cursor-pointer transition-transform hover:scale-110 ${getRoleBgColor(collab.role)}`}
                                                onMouseEnter={(e) => handleMouseEnter({
                                                    name: collab.user?.name || 'Collaborator',
                                                    role: collab.role,
                                                    status: collab.isActiveNow ? 'online' : 'offline'
                                                }, e)}
                                                onMouseLeave={handleMouseLeave}
                                            >
                                                {(collab.user?.name || 'C').substring(0, 2).toUpperCase()}
                                            </div>
                                            <div className={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border border-white ${collab.isActiveNow ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`}></div>
                                        </div>
                                    );
                                })}

                                {/* Add Collaborator Button */}
                                <div className="relative">
                                    <button
                                        onClick={() => setShowCollaborateModal(true)}
                                        className="w-10 h-10 rounded-full border-2 border-white shadow-lg bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 flex items-center justify-center text-white cursor-pointer transition-all duration-300 hover:scale-125 transform hover:shadow-xl hover:shadow-green-500/30 animate-pulse"
                                        title="Add New Collaborator"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 4v16m8-8H4" />
                                        </svg>
                                    </button>
                                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-green-400 rounded-full border border-white animate-ping"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Proposal Information Section */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border border-orange-200 animate-slideInUp" style={{ animationDelay: '0.2s' }}>
                        <h2 className="text-2xl font-bold text-black mb-4 flex items-center">
                            <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                                <svg className="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            Collaborative Proposal
                        </h2>

                        <div className="grid md:grid-cols-3 gap-4">
                            <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                <div className="text-orange-600 text-sm font-semibold mb-1">Title</div>
                                <div className="text-black font-semibold">{proposal.title}</div>
                            </div>
                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <div className="text-blue-600 text-sm font-semibold mb-1">Principal Investigator</div>
                                <div className="text-black font-semibold">{proposal.author?.name || author?.user?.name || 'Unknown'}</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                <div className="text-green-600 text-sm font-semibold mb-1">Status</div>
                                <div className="px-3 py-1 rounded-full text-sm font-semibold inline-block bg-blue-100 text-blue-800">
                                    COLLABORATIVE REVIEW
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* AI & Reviewer Suggestions Section */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border border-purple-200 animate-slideInUp" style={{ animationDelay: '0.4s' }}>
                        <h3 className="text-xl font-bold text-black mb-6 flex items-center">
                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                </svg>
                            </div>
                            <div className="relative">
                                AI & Reviewer Suggestions
                                {/* Notification Badge as Superscript */}
                                <div className="absolute -top-2 -right-4">
                                    <div className="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                                        <span className="text-white text-xs font-bold">1</span>
                                    </div>
                                    <div className="absolute -top-1 -right-1 w-2 h-2 bg-red-600 rounded-full animate-ping"></div>
                                </div>
                            </div>
                        </h3>

                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {suggestions.map((suggestion, index) => (
                                <div key={suggestion.id} className={`p-4 rounded-lg border-l-4 ${suggestion.type === 'ai'
                                        ? 'bg-purple-50 border-purple-500'
                                        : 'bg-blue-50 border-blue-500'
                                    } ${index === 0 ? 'border-l-green-500 bg-green-50' : ''}`}>
                                    <div className="flex items-start gap-2 mb-2">
                                        <div className={`px-2 py-0.5 rounded-full text-xs font-semibold ${index === 0 ? 'bg-green-100 text-green-800' :
                                                suggestion.type === 'ai'
                                                    ? 'bg-purple-100 text-purple-800'
                                                    : 'bg-blue-100 text-blue-800'
                                            }`}>
                                            {suggestion.category}
                                        </div>
                                        {index === 0 && (
                                            <div className="px-2 py-0.5 bg-green-200 text-green-900 text-xs font-semibold rounded-full animate-pulse">
                                                LATEST
                                            </div>
                                        )}
                                        {suggestion.confidence && (
                                            <div className="text-xs text-gray-500">
                                                {suggestion.confidence}% confidence
                                            </div>
                                        )}
                                    </div>
                                    <h4 className="font-semibold text-black text-sm mb-1">{suggestion.title}</h4>
                                    <p className="text-sm text-gray-500 mb-2">{suggestion.content}</p>
                                    <div className="text-xs text-gray-500">
                                        {suggestion.author} â€¢ {suggestion.timestamp}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Advanced Proposal Editor */}
                    <div className="relative mb-6 animate-slideInUp" style={{ animationDelay: '0.6s' }}>
                        <AdvancedProposalEditor
                            initialContent={editorContent}
                            onContentChange={handleEditorContentChange}
                            onWordCountChange={handleWordCountChange}
                            onCharacterCountChange={handleCharacterCountChange}
                            proposalTitle={proposal?.title || 'Research Proposal'}
                            showStats={true}
                        />

                        {/* Inline Comments - Now handled by Plate.js built-in comment feature */}
                        {/* Use the comment button in the toolbar to add comments directly in the editor */}
                    </div>

                    {/* Note: Plate.js has built-in commenting feature accessible from the toolbar */}
                    <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-start gap-3">
                            <svg className="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <h4 className="font-semibold text-blue-900 mb-1">Collaborative Commenting</h4>
                                <p className="text-sm text-blue-700">
                                    Use the <strong>comment button</strong> in the editor toolbar to add inline comments and collaborate with your team members directly within the document.
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Save Changes Button - Separate from Editor */}
                    <div className="text-center mb-6">
                        <button
                            onClick={handleSaveChanges}
                            className="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 cursor-pointer"
                        >
                            Save Changes
                        </button>
                    </div>

                    {/* Floating Action Buttons - Properly Positioned */}

                    {/* Chat Toggle Button - Top position */}
                    {!showSaarthi && (
                        <div className="fixed bottom-48 right-8 z-30 group">
                            <button
                                onClick={() => setShowChatWindow(!showChatWindow)}
                                className={`w-16 h-16 rounded-2xl shadow-2xl transition-all duration-300 flex items-center justify-center transform hover:scale-110 hover:rotate-3 cursor-pointer ${showChatWindow
                                        ? 'bg-blue-700 text-white scale-110 rotate-3'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`}
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </button>
                            {/* Tooltip */}
                            <div className="absolute bottom-full right-0 mb-3 opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:translate-y-0 translate-y-2 pointer-events-none z-[60]">
                                <div className="bg-black/90 text-white px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap shadow-2xl backdrop-blur-sm border border-white/10">
                                    <div className="flex items-center gap-2">
                                        <span>Team Chat</span>
                                    </div>
                                    <div className="absolute top-full right-4 w-0 h-0 border-t-4 border-t-black/90 border-l-4 border-l-transparent border-r-4 border-r-transparent"></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Version History Button - Middle position */}
                    <VersionHistory
                        showVersionHistory={showVersionHistory}
                        setShowVersionHistory={setShowVersionHistory}
                        showSaarthi={showSaarthi}
                    />

                    {/* AI Assistant (Saarthi) - Bottom position */}
                    <Chatbot
                        showSaarthi={showSaarthi}
                        setShowSaarthi={setShowSaarthi}
                        showVersionHistory={showVersionHistory}
                        setShowVersionHistory={setShowVersionHistory}
                    />

                    {/* Chat Window Component */}
                    <ChatWindow
                        showChatWindow={showChatWindow}
                        setShowChatWindow={setShowChatWindow}
                        messages={chatMessages}
                        onSendMessage={handleChatMessageSend}
                    />

                </div>

                {/* Portal-based Tooltip */}
                {hoveredCollaborator && typeof window !== 'undefined' && createPortal(
                    <div
                        className="fixed pointer-events-none transition-opacity duration-200"
                        style={{
                            left: tooltipPosition.x,
                            top: tooltipPosition.y,
                            transform: 'translate(-50%, -100%)',
                            zIndex: 9999999
                        }}
                    >
                        <div className="bg-black/95 backdrop-blur-sm text-white px-4 py-3 rounded-xl text-sm font-medium whitespace-nowrap shadow-2xl border border-white/20 mb-2">
                            <div className="font-semibold">{hoveredCollaborator.name}</div>
                            <div className="text-xs text-gray-300">{hoveredCollaborator.role}</div>
                            <div className={`text-xs flex items-center gap-1 mt-1 ${hoveredCollaborator.status === 'online' ? 'text-green-300' :
                                    hoveredCollaborator.status === 'away' ? 'text-yellow-300' : 'text-gray-500'
                                }`}>
                                <div className={`w-1.5 h-1.5 rounded-full ${hoveredCollaborator.status === 'online' ? 'bg-green-400' :
                                        hoveredCollaborator.status === 'away' ? 'bg-yellow-400' : 'bg-gray-400'
                                    }`}></div>
                                {hoveredCollaborator.status}
                            </div>
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-t-4 border-t-black/95 border-l-4 border-l-transparent border-r-4 border-r-transparent"></div>
                        </div>
                    </div>,
                    document.body
                )}

                {/* Commit Modal (from edit page) */}
                {showCommitModal && (
                    <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.5)', backdropFilter: 'blur(4px)' }}>
                        <div className={`bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 ${isModalClosing ? 'animate-slideOutScale' : 'animate-slideInScale'
                            } ${isShaking ? 'animate-shake' : ''}`}>

                            {isSubmitting ? (
                                <div className="text-center">
                                    <div className="mb-6">
                                        <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg className="w-8 h-8 text-orange-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-black mb-2">Creating New Version</h3>
                                        <p className="text-gray-500 mb-4">{submissionStage}</p>
                                    </div>

                                    <div className="mb-4">
                                        <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-gradient-to-r from-orange-500 to-red-600 h-full transition-all duration-500 ease-out"
                                                style={{ width: `${submissionProgress}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-sm text-gray-500 mt-2">{submissionProgress}%</div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg className="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-black mb-2">Save Collaboration Changes</h3>
                                        <p className="text-gray-500">Create a new version with your changes and notify all collaborators</p>
                                    </div>

                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-black mb-2">Version Message</label>
                                        <textarea
                                            value={commitMessage}
                                            onChange={(e) => setCommitMessage(e.target.value)}
                                            className="w-full px-4 py-3 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-black resize-none"
                                            rows="3"
                                            placeholder="Describe the changes you made..."
                                        />
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleCloseModal}
                                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-500 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleCommitConfirm}
                                            className="flex-1 px-4 py-2 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white rounded-lg transition-all duration-300 font-semibold cursor-pointer"
                                        >
                                            Save Version
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                )}

                {/* Success Modal */}
                {showSuccessModal && (
                    <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.5)', backdropFilter: 'blur(4px)' }}>
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fadeInScale">
                            <div className="text-center">
                                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <h3 className="text-xl font-bold text-black mb-2">Version Saved Successfully!</h3>
                                <p className="text-gray-500 mb-4">Your changes have been saved and all collaborators have been notified.</p>
                                <button
                                    onClick={() => setShowSuccessModal(false)}
                                    className="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-semibold transition-all duration-300 cursor-pointer"
                                >
                                    Continue
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Collaboration Modal */}
                {showCollaborateModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg p-8 max-w-lg w-full mx-4 shadow-xl">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold text-gray-900">Invite Collaborator</h2>
                                <button
                                    onClick={() => {
                                        setShowCollaborateModal(false);
                                        setCollaboratorEmail('');
                                        setCollaboratorRole('');
                                        setCollaboratorDescription('');
                                    }}
                                    className="text-gray-500 hover:text-gray-700 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <div className="space-y-4">
                                {/* Email Field */}
                                <div>
                                    <label htmlFor="collaboratorEmail" className="block text-sm font-medium text-gray-700 mb-2">
                                        Collaborator Email Address *
                                    </label>
                                    <input
                                        type="email"
                                        id="collaboratorEmail"
                                        value={collaboratorEmail}
                                        onChange={(e) => setCollaboratorEmail(e.target.value)}
                                        placeholder="Enter email address"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        disabled={isInviting}
                                    />
                                </div>

                                {/* Role Selection */}
                                <div>
                                    <label htmlFor="collaboratorRole" className="block text-sm font-medium text-gray-700 mb-2">
                                        Role *
                                    </label>
                                    <select
                                        id="collaboratorRole"
                                        value={collaboratorRole}
                                        onChange={(e) => setCollaboratorRole(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        disabled={isInviting}
                                    >
                                        <option value="">Select a role</option>
                                        <option value="principal_investigator">Principal Investigator</option>
                                        <option value="admin">Administrator</option>
                                        <option value="reviewer">Reviewer</option>
                                        <option value="collaborator">Collaborator</option>
                                        <option value="observer">Observer</option>
                                    </select>
                                </div>

                                {/* Description Field */}
                                <div>
                                    <label htmlFor="collaboratorDescription" className="block text-sm font-medium text-gray-700 mb-2">
                                        Description (Optional)
                                    </label>
                                    <textarea
                                        id="collaboratorDescription"
                                        value={collaboratorDescription}
                                        onChange={(e) => setCollaboratorDescription(e.target.value)}
                                        placeholder="Brief description of their role and responsibilities..."
                                        className="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        rows="3"
                                        disabled={isInviting}
                                    />
                                </div>
                            </div>

                            <div className="flex gap-4 mt-6">
                                <button
                                    onClick={() => {
                                        setShowCollaborateModal(false);
                                        setCollaboratorEmail('');
                                        setCollaboratorRole('');
                                        setCollaboratorDescription('');
                                    }}
                                    className="flex-1 px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-medium"
                                    disabled={isInviting}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleCollaborateInvite}
                                    disabled={!collaboratorEmail || !collaboratorRole || isInviting}
                                    className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
                                >
                                    {isInviting ? (
                                        <>
                                            <svg className="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                            Sending...
                                        </>
                                    ) : (
                                        <>
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            Send Invitation
                                        </>
                                    )}
                                </button>
                            </div>

                            <div className="mt-4 p-3 bg-blue-50 rounded-md">
                                <p className="text-sm text-blue-700">
                                    <strong>Note:</strong> An email invitation will be sent to the collaborator with their assigned role and instructions to join this collaborative workspace.
                                </p>
                            </div>
                        </div>
                    </div>
                )}

                {/* Collaborators List Modal */}
                {showCollaboratorsList && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 shadow-xl max-h-[80vh] overflow-y-auto">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                    <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    All Collaborators
                                </h2>
                                <button
                                    onClick={() => setShowCollaboratorsList(false)}
                                    className="text-gray-500 hover:text-gray-700 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <div className="mb-4 flex items-center justify-between">
                                <div className="text-sm text-gray-600">
                                    <span className="font-semibold">{activeCollaborators.length}</span> active now â€¢ <span className="font-semibold">{collaborators.length + 1}</span> total members
                                </div>
                                <button
                                    onClick={() => {
                                        setShowCollaboratorsList(false);
                                        setShowCollaborateModal(true);
                                    }}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 text-sm font-medium"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                    Invite New
                                </button>
                            </div>

                            <div className="space-y-3">
                                {/* Author */}
                                {author && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="relative">
                                                    <div className="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg">
                                                        {(author.user?.name || 'A').substring(0, 2).toUpperCase()}
                                                    </div>
                                                    {author.isActiveNow && (
                                                        <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
                                                    )}
                                                </div>
                                                <div>
                                                    <div className="font-semibold text-gray-900">{author.user?.name}</div>
                                                    <div className="text-sm text-gray-600">{author.user?.email}</div>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                                                            Principal Investigator
                                                        </span>
                                                        {author.isActiveNow && (
                                                            <span className="px-2 py-0.5 bg-green-100 text-green-800 text-xs font-semibold rounded-full flex items-center gap-1">
                                                                <div className="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                                                                Online
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Collaborators */}
                                {collaborators.map((collab) => {
                                    const getRoleColor = (role) => {
                                        switch(role) {
                                            case 'admin': return 'bg-purple-100 text-purple-800';
                                            case 'reviewer': return 'bg-orange-100 text-orange-800';
                                            case 'collaborator': return 'bg-green-100 text-green-800';
                                            case 'observer': return 'bg-gray-100 text-gray-800';
                                            default: return 'bg-indigo-100 text-indigo-800';
                                        }
                                    };
                                    
                                    const getRoleBgColor = (role) => {
                                        switch(role) {
                                            case 'admin': return 'bg-purple-600';
                                            case 'reviewer': return 'bg-orange-600';
                                            case 'collaborator': return 'bg-green-600';
                                            case 'observer': return 'bg-gray-600';
                                            default: return 'bg-indigo-600';
                                        }
                                    };

                                    return (
                                        <div key={collab._id} className="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className="relative">
                                                        <div className={`w-12 h-12 rounded-full ${getRoleBgColor(collab.role)} flex items-center justify-center text-white font-bold text-lg`}>
                                                            {(collab.user?.name || 'C').substring(0, 2).toUpperCase()}
                                                        </div>
                                                        {collab.isActiveNow && (
                                                            <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
                                                        )}
                                                    </div>
                                                    <div>
                                                        <div className="font-semibold text-gray-900">{collab.user?.name}</div>
                                                        <div className="text-sm text-gray-600">{collab.user?.email}</div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${getRoleColor(collab.role)}`}>
                                                                {collab.role.replace('_', ' ')}
                                                            </span>
                                                            {collab.isActiveNow && (
                                                                <span className="px-2 py-0.5 bg-green-100 text-green-800 text-xs font-semibold rounded-full flex items-center gap-1">
                                                                    <div className="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                                                                    Online
                                                                </span>
                                                            )}
                                                            {collab.status === 'pending' && (
                                                                <span className="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">
                                                                    Pending
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            Invited {collab.invitedAt ? new Date(collab.invitedAt).toLocaleDateString() : 'recently'}
                                                        </div>
                                                    </div>
                                                </div>
                                                {(user?._id === proposal?.author?._id || user?._id === proposal?.author || author?.user?._id === user?._id) && (
                                                    <button
                                                        onClick={() => handleRemoveCollaborator(collab._id)}
                                                        className="px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition-colors text-sm font-medium"
                                                    >
                                                        Remove
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </>
    );
}

export default function CollaborateProposal() {
    return (
        <ProtectedRoute>
            <CollaborateContent />
        </ProtectedRoute>
    );
}
